{{TAGDEF|PLUGINS/FORCE_AND_STRESS| .True. {{!}} .False.|.False.}}

Description: {{TAG|PLUGINS/FORCE_AND_STRESS}} calls the Python plugin for the force and stress interface for each ionic relaxation step
----

When {{TAG|PLUGINS/FORCE_AND_STRESS}}=.TRUE., VASP calls the <code>force_and_stress</code> Python function at the end of each ionic relaxation step.
You can use this tag to modify forces and the stress tensor to be consistent with modifications to the potential performed with {{TAG|PLUGINS/LOCAL_POTENTIAL}}.
Furthermore, you could implement new force corrections like van-der-Waals functionals.

==Expected inputs==

The <code>force_and_stress</code> Python function expects the following inputs,
<syntaxhighlight lang="python" line>
def force_and_stress(constants, additions):
</syntaxhighlight>
where <code>constants</code> and <code>additions</code> and [https://docs.python.org/3/library/dataclasses.html Python dataclasses].
The <code>constants</code> dataclass consists of the following inputs, listed here with their associated [https://numpy.org/doc/stable/user/basics.types.html datatypes]
<syntaxhighlight lang="python" line>
@dataclass(frozen=True)
class ConstantsForceAndStress:
    ENCUT: float
    NELECT: float
    shape_grid: IntArray
    number_ions: int
    number_ion_types: int
    ion_types: IndexArray
    atomic_numbers: IntArray
    lattice_vectors: DoubleArray
    positions: DoubleArray
    ZVAL: DoubleArray
    POMASS: DoubleArray
    forces: DoubleArray
    stress: DoubleArray
    charge_density: Optional[DoubleArray] = None
</syntaxhighlight>
Note that the {{FILE|INCAR}} tags are capitalized.
<code>shape_grid</code> is a three dimensional integer array which stores the shape of the real space grid, {{TAG|NGXF}}, {{TAG|NGYF}} and {{TAG|NGZF}},
<code>number_ions</code> is the total number of ions listed in the {{FILE|POSCAR}} file,
<code>number_ion_types</code> is the number of ion corresponding to each ion type in the convention of the {{FILE|POSCAR}} file,
<code>ion_types</code> stores the total number of ion types,
<code>atomic_numbers</code> contains the atomic number for each atom type,
<code>lattice_vectors</code> and <code>positions</code> contain the lattice vectors and positions of the current SCF step
<code>forces</code> and <code>stress</code> are the computed forces and stress tensor and <code>charge_density</code> contains the charge density on the real space grid.

The <code>additions</code> dataclass consists of the following modifiable outputs
<syntaxhighlight lang="python" line>
@dataclass
class AdditionsForceAndStress:
    total_energy: float
    forces: DoubleArray
    stress: DoubleArray
</syntaxhighlight>

==Modifying quantities==
Modify the quantities listed in additions by adding to them. For example, if you wanted to add one to the forces
<syntaxhighlight lang="python" line>
import numpy as np
def force_and_stress(constants, additions)
    additions.forces += np.ones((constants.number_ions,3))
</syntaxhighlight>
{{WARN_PLUGINS_CONSTANTS}}

== Related tags and articles ==
[[Plugins]],
{{TAG|PLUGINS/LOCAL_POTENTIAL}},
{{TAG|PLUGINS/MACHINE_LEARNING}},
{{TAG|PLUGINS/OCCUPANCIES}},
{{TAG|PLUGINS/STRUCTURE}}

{{sc|PLUGINS/FORCE_AND_STRESS|Examples|Examples that use this tag}}

[[Category:INCAR tag]]
